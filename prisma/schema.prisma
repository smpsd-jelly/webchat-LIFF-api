generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum ConversationStatus {
  open
  closed
}

enum SenderType {
  user
  admin
  system
}

enum AdminRole {
  admin
  superadmin
}

enum MessageType {
  text
  image
  sticker
  file
  system
}

enum MessageStatus {
  queued
  sent
  failed
  received
  read
}


model line_users {
  id            BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  line_user_id  String    @unique @db.VarChar(64)
  display_name  String?   @db.VarChar(255)
  picture_url   String?   @db.Text
  created_at    DateTime  @db.DateTime(0)
  last_seen_at  DateTime? @db.DateTime(0)

  conversation conversations?
  sessions     user_sessions[]
}

model conversations {
  id              BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  line_user_id    String              @unique @db.VarChar(64)
  status          ConversationStatus  @default(open)
  last_message_at DateTime?           @db.DateTime(0)

  last_message_text String?           @db.Text

  unread_admin_count Int              @default(0)
  unread_user_count  Int              @default(0)

  created_at      DateTime            @db.DateTime(0)

  updated_at      DateTime            @default(now()) @db.DateTime(0)

  user     line_users @relation(fields: [line_user_id], references: [line_user_id], onDelete: Cascade, onUpdate: Cascade)
  messages messages[]

  @@index([last_message_at], name: "idx_conversations_last_message_at")
  @@index([updated_at], name: "idx_conversations_updated_at")
}

model messages {
  id              BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  conversation_id BigInt     @db.UnsignedBigInt
  sender_type     SenderType
  message_type    MessageType   @default(text)
  text            String     @db.Text
  status          MessageStatus  @default(received)
  created_at      DateTime   @db.DateTime(0)
  raw_event       Json?

  admin_user_id   BigInt?    @db.UnsignedBigInt
  admin_user      admin_users? @relation(fields: [admin_user_id], references: [id], onDelete: SetNull, onUpdate: Cascade)

  conversation conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([conversation_id, created_at], name: "idx_messages_conversation_created")
  @@index([admin_user_id], name: "idx_messages_admin_user_id")
}

model admin_users {
  id            BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  line_user_id  String?    @unique @db.VarChar(64)
  display_name  String?    @db.VarChar(255)
  picture_url   String?    @db.Text
  username      String     @unique @db.VarChar(100)
  password_hash String     @db.VarChar(255)
  role          AdminRole  @default(admin)
  created_at    DateTime   @db.DateTime(0)

  sessions admin_sessions[]
  messages messages[]
}

model admin_sessions {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  admin_user_id BigInt   @db.UnsignedBigInt
  session_token String   @unique @db.VarChar(128)
  created_at    DateTime @db.DateTime(0)
  expires_at    DateTime @db.DateTime(0)

  admin admin_users @relation(fields: [admin_user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([admin_user_id], name: "idx_admin_sessions_admin_user_id")
}

model user_sessions {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  line_user_id  String   @db.VarChar(64)
  session_token String   @unique @db.VarChar(128)
  created_at    DateTime @db.DateTime(0)
  expires_at    DateTime @db.DateTime(0)

  user line_users @relation(fields: [line_user_id], references: [line_user_id], onDelete: Cascade, onUpdate: Cascade)

  @@index([line_user_id], name: "idx_user_sessions_line_user_id")
}
